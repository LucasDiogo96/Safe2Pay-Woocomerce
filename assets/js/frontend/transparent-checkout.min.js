/*global wc_safe2pay_params, PagSeguroDirectPayment, wc_checkout_params */
(function ($) {
    'use strict';

    $(function () {

        var safe2pay_submit = false;

     
        function safe2PaySetCreditCardBrand(brand) {
            $('#safe2pay-credit-card-form').attr('data-credit-card-brand', brand);
        }

     
        function safe2PayGetPriceText(installment) {
            var installmentParsed = 'R$ ' + parseFloat(installment.installmentAmount, 10).toFixed(2).replace('.', ',').toString();
            var totalParsed = 'R$ ' + parseFloat(installment.totalAmount, 10).toFixed(2).replace('.', ',').toString();
            var interestFree = (true === installment.interestFree) ? ' ' + wc_safe2pay_params.interest_free : '';
            var interestText = interestFree ? interestFree : ' (' + totalParsed + ')';

            return installment.quantity + 'x ' + installmentParsed + interestText;
        }

       
        function safe2PayGetInstallmentOption(installment) {
            return '<option value="' + installment.quantity + '" data-installment-value="' + installment.installmentAmount + '">' + safe2PayGetPriceText(installment) + '</option>';
        }

        
        function safe2PayAddErrorMessage(error) {
            var wrapper = $('#safe2pay-credit-card-form');

            $('.woocommerce-error', wrapper).remove();
            wrapper.prepend('<div class="woocommerce-error" style="margin-bottom: 0.5em !important;">' + error + '</div>');
        }

        /**
         * Hide payment methods if have only one.
         */
        function safe2PayHidePaymentMethods() {
            var paymentMethods = $('#safe2pay-payment-methods');

            if (1 === $('input[type=radio]', paymentMethods).length) {
                paymentMethods.hide();
            }
        }

        /**
         * Show/hide the method form.
         *
         * @param {string} method
         */
        function safe2PayShowHideMethodForm(method) {
            // window.alert( method );
            $('.safe2pay-method-form').hide();
            $('#safe2pay-payment-methods li').removeClass('active');
            $('#safe2pay-' + method + '-form').show();
            $('#safe2pay-payment-method-' + method).parent('label').parent('li').addClass('active');
        }

        /**
         * Initialize the payment form.
         */
        function safe2PayInitPaymentForm() {
            safe2PayHidePaymentMethods();

            $('#safe2pay-payment-form').show();

            safe2PayShowHideMethodForm($('#safe2pay-payment-methods input[type=radio]:checked').val());

            // // CPF.
            // $('#safe2pay-card-holder-cpf').mask('000.000.000-00');

            // // Birth Date.
            // $('#safe2pay-card-holder-birth-date').mask('00/00/0000');

            // Phone.
            var MaskBehavior = function (val) {
                    return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
                },
                maskOptions = {
                    onKeyPress: function (val, e, field, options) {
                        field.mask(MaskBehavior.apply({}, arguments), options);
                    }
                };

            // $('#safe2pay-card-holder-phone').mask(MaskBehavior, maskOptions);

            // $('#safe2pay-bank-transfer-form input[type=radio]:checked').parent('label').parent('li').addClass('active');
        }

        /**
         * Form Handler.
         *
         * @return {bool}
         */
        function safe2PayformHandler() {
            if (safe2pay_submit) {
                safe2pay_submit = false;

                return true;
            }

            if (!$('#payment_method_safe2pay').is(':checked')) {
                return true;
            }

            if ('credit-card' !== $('body li.payment_method_safe2pay input[name=safe2pay_payment_method]:checked').val()) {
                $('form.checkout, form#order_review').append($('<input name="safe2pay_sender_hash" type="hidden" />').val(PagSeguroDirectPayment.getSenderHash()));

                return true;
            }

            var form = $('form.checkout, form#order_review'),
                creditCardForm = $('#safe2pay-credit-card-form', form),
                error = false,
                errorHtml = '',
                holder =  $('#safe2pay-card-holder-name').val(),
                holderIdentity = $( '#safe2pay-card-holder-cpf', form ).val().replace(/[^\d]/g, ''),
                brand = creditCardForm.attr('data-credit-card-brand'),
                cardNumber = $('#safe2pay-card-number', form).val().replace(/[^\d]/g, ''),
                cvv = $('#safe2pay-card-cvc', form).val(),
                expiration = $( '#safe2pay-card-expiry', form ).val(),
                expirationMonth = expiration.replace(/[^\d]/g, '').substr(0, 2),
                expirationYear = expiration.replace(/[^\d]/g, '').substr(2),
                installments = $('#safe2pay-card-installments', form),
                today = new Date();

            // Validate the credit card data.
            errorHtml += '<ul>';


            // Validate the expiry date.
            if (2 !== expirationMonth.length || 4 !== expirationYear.length) {
                errorHtml += '<li>' + wc_safe2pay_params.invalid_expiry + '</li>';
                error = true;
            }

            if ((2 === expirationMonth.length && 4 === expirationYear.length) && (expirationMonth > 12 || expirationYear <= (today.getFullYear() - 1) || expirationYear >= (today.getFullYear() + 20) || (expirationMonth < (today.getMonth() + 2) && expirationYear.toString() === today.getFullYear().toString()))) {
                errorHtml += '<li>' + wc_safe2pay_params.expired_date + '</li>';
                error = true;
            }

            // Installments.
            if ('0' === installments.val()) {
                errorHtml += '<li>' + wc_safe2pay_params.empty_installments + '</li>';
                error = true;
            }

            errorHtml += '</ul>';
            // Create the card token.
            if (!error) {

                $('input[name=safe2pay_credit_card_hash], input[name=safe2pay_credit_card_hash], input[name=safe2pay_installment_value]', form).remove();

                //add credit card
                //Holder
                form.append( $( '<input name="safe2pay-card-holder-name" type="hidden" />' ).val(holder));
                //Number
                form.append( $( '<input name="safe2pay-card-number" type="hidden" />' ).val( cardNumber ) );
                //Expiration Date
                form.append( $( '<input name="safe2pay-card-expiry-field" type="hidden" />' ).val(expiration) );
                //CVC
                form.append( $( '<input name="safe2pay-card-cvc" type="hidden" />' ).val(cvv));
                //Instalmentes
                form.append( $( '<input name="safe2pay-card-installments" type="hidden" />' ).val(installments.val()));
                
    
                // Submit the form.
                safe2pay_submit = true;
                form.submit();
            }else{
                safe2PayAddErrorMessage( errorHtml );
            }

            return false;
        }
        
        $('body').on('updated_checkout', function () {
            safe2PayInitPaymentForm();
        });

        // Switch the payment method form.
        $( 'body' ).on( 'click', '#safe2pay-payment-methods input[type=radio]', function() {
            safe2PayShowHideMethodForm( $( this ).val() );
        });

        // Get the credit card brand.
        $( 'body' ).on( 'focusout', '#safe2pay-card-number', function() {
            var bin = $( this ).val().replace( /[^\d]/g, '' ).substr( 0, 6 ),
                instalmments = $( 'body #safe2pay-card-installments' );

            if ( 6 === bin.length ) {
                // Reset the installments.
                instalmments.empty();
                instalmments.attr( 'disabled', 'disabled' );

                PagSeguroDirectPayment.getBrand({
                    cardBin: bin,
                    success: function( data ) {
                        $( 'body' ).trigger( 'safe2pay_credit_card_brand', data.brand.name );
                        safe2PaySetCreditCardBrand( data.brand.name );
                    },
                    error: function() {
                        $( 'body' ).trigger( 'safe2pay_credit_card_brand', 'error' );
                        safe2PaySetCreditCardBrand( 'error' );
                    }
                });
            }
        });
        $( 'body' ).on( 'updated_checkout', function() {
            var field = $( 'body #safe2pay-card-number' );

            if ( 0 < field.length ) {
                field.focusout();
            }
        });

        // Set the errors.
        $( 'body' ).on( 'focus', '#safe2pay-card-number, #safe2pay-card-expiry', function() {
            $( '#safe2pay-credit-card-form .woocommerce-error' ).remove();
        });

        // Get the installments.
        $( 'body' ).on( 'safe2pay_credit_card_brand', function( event, brand ) {
            if ( 'error' !== brand ) {
                PagSeguroDirectPayment.getInstallments({
                    amount: $( 'body #safe2pay-payment-form' ).data( 'cart_total' ),
                    brand: brand,
                    success: function( data ) {
                        var instalmments = $( 'body #safe2pay-card-installments' );

                        if ( false === data.error ) {
                            instalmments.empty();
                            instalmments.removeAttr( 'disabled' );
                            instalmments.append( '<option value="0">--</option>' );

                            $.each( data.installments[brand], function( index, installment ) {
                                instalmments.append( safe2PayGetInstallmentOption( installment ) );
                            });
                        } else {
                            safe2PayAddErrorMessage( wc_safe2pay_params.invalid_card );
                        }
                    },
                    error: function() {
                        safe2PayAddErrorMessage( wc_safe2pay_params.invalid_card );
                    }
                });
            } else {
                safe2PayAddErrorMessage( wc_safe2pay_params.invalid_card );
            }
        });

        // Process the credit card data when submit the checkout form.
        $( 'form.checkout' ).on( 'checkout_place_order_safe2pay', function() {
            return safe2PayformHandler();
        });

        $( 'form#order_review' ).submit( function() {
            return safe2PayformHandler();
        });
    
    });

}(jQuery));